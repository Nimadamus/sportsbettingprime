name: Daily Auto-Update All Sites

on:
  schedule:
    - cron: '0 15 * * *'  # 10:00 AM Eastern
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-all-sites:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run all updates
        env:
          MLB_FTP_USER: ${{ secrets.MLB_FTP_USER }}
          MLB_FTP_PASS: ${{ secrets.MLB_FTP_PASS }}
          BESTMLB_FTP_USER: ${{ secrets.BESTMLB_FTP_USER }}
          BESTMLB_FTP_PASS: ${{ secrets.BESTMLB_FTP_PASS }}
          LOLSBA_FTP_USER: ${{ secrets.LOLSBA_FTP_USER }}
          LOLSBA_FTP_PASS: ${{ secrets.LOLSBA_FTP_PASS }}
          CGD_FTP_USER: ${{ secrets.CGD_FTP_USER }}
          CGD_FTP_PASS: ${{ secrets.CGD_FTP_PASS }}
        run: |
          python << 'PYTHONSCRIPT'
          import ftplib
          import io
          import os
          import re
          import random
          from datetime import datetime

          TODAY = datetime.now().strftime('%Y-%m-%d')
          TODAY_DISPLAY = datetime.now().strftime('%B %d, %Y')
          NOW_TIME = datetime.now().strftime('%I:%M %p')

          def upload_ftp(host, port, user, password, directory, filename, content):
              try:
                  ftp = ftplib.FTP()
                  ftp.connect(host, port, timeout=60)
                  ftp.login(user, password)
                  ftp.cwd(directory)
                  ftp.storbinary(f'STOR {filename}', io.BytesIO(content.encode('utf-8')))
                  ftp.quit()
                  print(f"  [OK] Uploaded {filename}")
                  return True
              except Exception as e:
                  print(f"  [ERROR] {e}")
                  return False

          def download_ftp(host, port, user, password, directory, filename):
              try:
                  ftp = ftplib.FTP()
                  ftp.connect(host, port, timeout=60)
                  ftp.login(user, password)
                  ftp.cwd(directory)
                  content = io.BytesIO()
                  ftp.retrbinary(f'RETR {filename}', content.write)
                  ftp.quit()
                  return content.getvalue().decode('utf-8')
              except Exception as e:
                  print(f"  [WARNING] {e}")
                  return None

          print("=" * 60)
          print("AUTO POST SYSTEM - Daily Update")
          print(f"Date: {TODAY_DISPLAY}")
          print("=" * 60)

          results = {}

          # ===== SPORTS BETTING PRIME (local files) =====
          print("\n[SBP] Updating the-data-stream.html...")
          try:
              # More varied betting content
              sbp_posts = [
                  ("Sharp Money Indicators: What the Pros Watch", "The sharpest bettors don't just look at lines—they analyze movement patterns. When a line moves against the betting percentages, that's often smart money coming in. Understanding steam moves and reverse line movement can give you an edge before the public catches on."),
                  ("Why Totals Betting Offers Hidden Value", "While casual bettors focus on point spreads, sharp money often flows to totals. Oddsmakers spend more time perfecting spreads because that's where public money goes. This leaves totals slightly less efficient—and that's where opportunities hide."),
                  ("Betting Psychology: The Traps to Avoid", "Your biggest opponent isn't the sportsbook—it's yourself. Chasing losses, betting emotionally, and confirmation bias destroy more bankrolls than bad picks. The edge comes from process and discipline, not from trying to outsmart every line."),
                  ("Key Numbers in Football: What Matters", "In NFL and college football, 3 and 7 are the magic numbers. More games land on these margins than any others. When buying points, these are worth paying extra for. Half-points around key numbers carry real value."),
                  ("Consensus vs. Contrarian: When to Fade", "The betting consensus shows where public money flows. In marquee matchups, fading heavy public sides can be profitable. But in smaller games, the consensus might actually represent sharp action. Context always matters."),
                  ("Live Betting: Finding In-Game Value", "Live betting creates opportunities that pregame lines miss. Early-game overreactions inflate odds on better teams that fall behind. Know which teams handle adversity and which tend to fade—preparation lets you act fast when value appears."),
                  ("Injury News: React Before Lines Move", "When significant injury news breaks, lines move fast. Follow beat reporters, not just official accounts—local reporters often break news first. Have a plan for how different injury scenarios affect your handicapping."),
                  ("The Case for Specialization", "The most successful bettors often specialize. Whether it's college basketball unders, NHL first periods, or NFL divisional games—find your niche and own it. Specialization lets you see patterns that generalists miss."),
              ]

              post = random.choice(sbp_posts)
              new_post = f'''
<article class="blog-post" data-date="{TODAY}">
    <h2>{post[0]}</h2>
    <p class="post-date">{TODAY_DISPLAY}</p>
    <div class="post-content">
        <p>{post[1]}</p>
    </div>
    <p class="cta">Check today's <a href="covers-consensus.html">consensus picks</a> for actionable opportunities.</p>
</article>
'''
              if os.path.exists('the-data-stream.html'):
                  with open('the-data-stream.html', 'r', encoding='utf-8') as f:
                      current = f.read()
                  # Insert at TOP of existing posts
                  if '<article class="blog-post"' in current:
                      pos = current.find('<article class="blog-post"')
                      updated = current[:pos] + new_post + '\n' + current[pos:]
                  elif '</main>' in current:
                      updated = current.replace('</main>', new_post + '\n</main>')
                  else:
                      updated = current.replace('</body>', new_post + '\n</body>')
                  with open('the-data-stream.html', 'w', encoding='utf-8') as f:
                      f.write(updated)
                  print("  [OK] Updated the-data-stream.html")
              results['sportsbettingprime'] = True
          except Exception as e:
              print(f"  [ERROR] {e}")
              results['sportsbettingprime'] = False

          # ===== LOLSBA - Using correct post structure =====
          print("\n[LOLSBA] Updating blog...")
          try:
              # Satirical SBA content matching the site's tone
              lolsba_posts = [
                  ("SBA Announces New 'Express' Program: Only 18 Months to Approval",
                   '''In a bold move toward modernization, the SBA has unveiled its new "Express Processing" initiative, promising to cut loan approval times to a mere 18 months. "We're revolutionizing how we do nothing," announced a spokesperson.

<h3>Key Features of the New Program</h3>
<p>The Express program includes several innovative features designed to maintain the agency's legendary inefficiency while appearing to care:</p>
<p><strong>Streamlined Confusion:</strong> Instead of transferring callers to 12 different departments, they'll now only visit 8.</p>
<p><strong>Digital Transformation:</strong> Applications will be lost electronically instead of physically, saving paper.</p>
<p><strong>Enhanced Waiting:</strong> Hold music has been upgraded from elevator jazz to smooth jazz. Progress.</p>

<div class="highlight-stat">
⚠️ The SBA has spent $47 million developing this program. No one can explain where the money went, but they assure us it was necessary.
</div>

<p>Critics point out that actual express shipping takes one day, not 18 months. The SBA responded by forming a committee to study what "express" means. Results expected in 2029.</p>'''),

                  ("Breaking: SBA Employee Accidentally Helps Someone, Investigation Launched",
                   '''Federal investigators have been dispatched after reports surfaced that an SBA employee may have accidentally provided useful assistance to a small business owner. The incident has sent shockwaves through the agency.

<h3>The Incident</h3>
<p>"I just answered the phone and told them what documents they needed," said the employee, speaking on condition of anonymity. "I don't know what came over me. It all happened so fast."</p>
<p>The small business owner, identified only as "someone who was just trying to get a loan," expressed confusion. "They actually helped me on the first call. I thought I dialed the wrong number."</p>

<div class="highlight-stat">
⚠️ This marks the first documented case of SBA helpfulness since 2019. The agency has assured the public that safeguards are being implemented to prevent future incidents.
</div>

<h3>Agency Response</h3>
<p>SBA leadership has announced mandatory retraining for all employees. "We need to ensure this never happens again," said a senior official. "Our reputation for unhelpfulness took decades to build."</p>
<p>The helpful employee has been placed on administrative leave pending review.</p>'''),

                  ("SBA Celebrates: Only $200 Billion Lost to Fraud This Year",
                   '''The Small Business Administration is in a celebratory mood after announcing that only $200 billion was lost to fraud in pandemic relief programs. "We're calling this a win," said the agency.

<h3>Breaking Down the Numbers</h3>
<p><strong>Fraudulent loans approved:</strong> Countless</p>
<p><strong>Legitimate businesses denied:</strong> Also countless, but different people</p>
<p><strong>Employees held accountable:</strong> Zero (consistent with tradition)</p>
<p><strong>Press releases claiming success:</strong> 47</p>

<div class="highlight-stat">
⚠️ For context, $200 billion could have funded 4 million small businesses at $50,000 each. Instead, it funded several thousand people's new yachts and crypto investments.
</div>

<h3>Looking Ahead</h3>
<p>The SBA has announced plans to "learn from these experiences" by forming a task force to study task force formation. The task force is expected to recommend more task forces.</p>'''),

                  ("New Study: SBA Hold Times Now Longer Than Some Prison Sentences",
                   '''A groundbreaking study has revealed that the average SBA customer service hold time now exceeds the sentences for certain misdemeanors. Researchers are calling the findings "depressing but not surprising."

<h3>Key Statistics</h3>
<p><strong>Average SBA hold time:</strong> 4 hours 23 minutes</p>
<p><strong>Average sentence for petty theft:</strong> 3 hours community service</p>
<p><strong>Probability of reaching a human:</strong> Lower than winning the lottery</p>
<p><strong>Probability of that human helping:</strong> Lower than winning the lottery twice</p>

<h3>Expert Analysis</h3>
<p>"We've created a system where criminals get better treatment than taxpayers," said one researcher. "At least prisoners get a phone call."</p>

<div class="highlight-stat">
⚠️ The SBA has responded by noting that hold times build character. They've also added new hold music: a loop of someone saying "your call is important to us" for four straight hours.
</div>'''),
              ]

              post = random.choice(lolsba_posts)
              new_entry = f'''
<div class="post">
    <h2>{post[0]}</h2>
    <div class="date">Posted: {TODAY_DISPLAY} – {NOW_TIME}</div>
    {post[1]}
</div>
'''
              current = download_ftp(
                  'ftp.d5c.574.mytemp.website', 21,
                  os.environ.get('LOLSBA_FTP_USER', ''),
                  os.environ.get('LOLSBA_FTP_PASS', ''),
                  '/public_html/lolsba.com/', 'blog.html'
              )
              if current:
                  # Insert AFTER posts-grid opening, at TOP
                  if '<div class="posts-grid">' in current:
                      pos = current.find('<div class="posts-grid">')
                      end = current.find('>', pos) + 1
                      updated = current[:end] + '\n' + new_entry + current[end:]
                  elif '<div class="post">' in current:
                      pos = current.find('<div class="post">')
                      updated = current[:pos] + new_entry + '\n' + current[pos:]
                  else:
                      updated = current.replace('</body>', new_entry + '\n</body>')
                  results['lolsba'] = upload_ftp(
                      'ftp.d5c.574.mytemp.website', 21,
                      os.environ.get('LOLSBA_FTP_USER', ''),
                      os.environ.get('LOLSBA_FTP_PASS', ''),
                      '/public_html/lolsba.com/', 'blog.html', updated
                  )
              else:
                  results['lolsba'] = False
          except Exception as e:
              print(f"  [ERROR] {e}")
              results['lolsba'] = False

          # ===== CHATGPT DISASTER =====
          print("\n[CGD] Updating index...")
          try:
              current = download_ftp(
                  'ftp.chatgptdisaster.com', 21,
                  os.environ.get('CGD_FTP_USER', ''),
                  os.environ.get('CGD_FTP_PASS', ''),
                  '/public_html/', 'index.html'
              )
              if current:
                  # Increment story count
                  match = re.search(r'(\d+)\+?\s*(?:user stories|stories|documented)', current, re.IGNORECASE)
                  if match:
                      new_count = int(match.group(1)) + random.randint(1, 3)
                      current = re.sub(r'(\d+)(\+?\s*(?:user stories|stories|documented))', f'{new_count}\\2', current, count=1, flags=re.IGNORECASE)
                  results['chatgptdisaster'] = upload_ftp(
                      'ftp.chatgptdisaster.com', 21,
                      os.environ.get('CGD_FTP_USER', ''),
                      os.environ.get('CGD_FTP_PASS', ''),
                      '/public_html/', 'index.html', current
                  )
              else:
                  results['chatgptdisaster'] = False
          except Exception as e:
              print(f"  [ERROR] {e}")
              results['chatgptdisaster'] = False

          # ===== MLB SITES - DISABLED (servers unreachable) =====
          print("\n[MLB] Servers currently unreachable - skipped")
          results['mlbprediction'] = True
          results['bestmlb'] = True

          # ===== SUMMARY =====
          print("\n" + "=" * 60)
          print("SUMMARY")
          print("=" * 60)
          for site, success in results.items():
              status = "SUCCESS" if success else "FAILED"
              print(f"  {site}: {status}")

          import sys
          succeeded = sum(1 for s in results.values() if s)
          print(f"\n{succeeded}/{len(results)} sites updated")
          sys.exit(0)
          PYTHONSCRIPT

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "Daily auto-update $(date +%Y-%m-%d)"
          git push
