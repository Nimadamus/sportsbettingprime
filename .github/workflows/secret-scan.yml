name: Secret Scanning

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets
        run: |
          echo "Scanning for hardcoded secrets..."

          # Patterns to detect
          PATTERNS=(
            "Warriors2025"
            "deeac7e7af6a8f1a5ac84c625e04973a"
            "master@bestmlbhandicapper"
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api.key\s*=\s*['\"][a-zA-Z0-9]{20,}['\"]"
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(grep -r -E "$pattern" --include="*.py" --include="*.js" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".env.example" | grep -v "secret-scan.yml" || true)
            if [ -n "$MATCHES" ]; then
              echo "FOUND SECRET PATTERN: $pattern"
              echo "$MATCHES"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "::error::Secrets detected in codebase! Remove them and use environment variables."
            exit 1
          fi

          echo "No secrets detected."

      - name: Check for .env files
        run: |
          if find . -name ".env" -o -name ".env.local" -o -name "*.env" 2>/dev/null | grep -v ".env.example" | grep -q .; then
            echo "::error::.env file detected! These should never be committed."
            exit 1
          fi
          echo "No .env files in repository."
